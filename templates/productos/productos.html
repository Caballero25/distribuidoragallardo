{% extends 'base/base_adminlte.html' %}
{% load static %}
{% block title %} Productos {% endblock %}
{% block extra_head %}
{% endblock %}

{% block content %}
<h1>Productos</h1>

<!-- Formulario de búsqueda -->
<form method="GET" action="{% url 'get_producto_by_name' %}">
  <label for="buscar">Buscar por nombre:</label>
  <input type="text" name="buscar" id="buscar">
  <button type="submit">Buscar</button>
</form>

<table>
  <thead>
  <tr>
    <th>ID</th>
    <th>Código</th>
    <th>Nombre</th>
    <th>Existencia</th>
    <th>Valor Unitario</th>
    <th>Entradas</th>
    <th>Salidas</th>
    <th>Costo Unitario</th>
    <th>Editar</th>
    <th>Eliminar</th>
  </tr>
  </thead>
  <tbody>
  {% for producto in productos %}
  <tr>
    <td>{{ producto.id }}</td>
    <td>{{ producto.codigo }}</td>
    <td>{{ producto.nombre }}</td>
    <td>{{ producto.existencia }}</td>
    <td>{{ producto.valor_unitario }}</td>
    <td>{{ producto.entradas }}</td>
    <td>{{ producto.salidas }}</td>
    <td>{{ producto.costo_unitario }}</td>
    <td>
      <!-- Botón para abrir el modal de edición -->
      <button onclick="openEditModal('{{ producto.id }}', '{{ producto.nombre }}', '{{ producto.codigo }}', '{{ producto.valor_unitario }}')">
        <i class="fas fa-pencil-alt"></i>
      </button>
    </td>
    <td>
      <!-- Botón para abrir el modal de eliminación -->
      <button onclick="openDeleteModal('{{ producto.id }}', '{{ producto.nombre }}')">
        <i class="fas fa-trash-alt"></i>
      </button>
    </td>
  </tr>
  {% endfor %}
  </tbody>
</table>

<!-- MODAL PARA EDITAR PRODUCTO -->
<div id="editModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);">
  <div style="background: white; padding: 20px; margin: 10% auto; width: 50%;">
    <h2>Editar Producto</h2>
    <form id="editForm" method="post">
      {% csrf_token %}
      <label for="editNombre">Nombre:</label>
      <input type="text" id="editNombre" name="nombre" required><br>

      <label for="editCodigo">Código:</label>
      <input type="text" id="editCodigo" name="codigo" required><br>

      <label for="editValor">Valor Unitario:</label>
      <input type="number" id="editValor" name="valor_unitario" step="0.01" required><br>

      <button type="submit">Guardar</button>
      <button type="button" onclick="closeEditModal()">Cancelar</button>
    </form>
  </div>
</div>

<!-- MODAL PARA ELIMINAR PRODUCTO -->
<div id="deleteModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);">
  <div style="background: white; padding: 20px; margin: 10% auto; width: 30%;">
    <h2>¿Eliminar Producto?</h2>
    <p id="deleteMessage"></p>
    <button onclick="confirmDelete()">Sí, eliminar</button>
    <button onclick="closeDeleteModal()">Cancelar</button>
  </div>
</div>

<script>
  function openEditModal(id, nombre, codigo, valor) {
    document.getElementById("editNombre").value = nombre;
    document.getElementById("editCodigo").value = codigo;
    document.getElementById("editValor").value = valor;
    document.getElementById("editForm").action = "/productos/" + "/update/" + id ;
    document.getElementById("editModal").style.display = "block";
  }

  function closeEditModal() {
    document.getElementById("editModal").style.display = "none";
  }

  function openDeleteModal(id, nombre) {
    document.getElementById("deleteMessage").innerText = "¿Estás seguro de que deseas eliminar el producto " + nombre + "?";
    document.getElementById("deleteModal").dataset.productoId = id;
    document.getElementById("deleteModal").style.display = "block";
  }

  function closeDeleteModal() {
    document.getElementById("deleteModal").style.display = "none";
  }

  function confirmDelete() {
    let productoId = document.getElementById("deleteModal").dataset.productoId;
    window.location.href = "/productos/" + "/eliminar/" + productoId ;
  }
</script>
{% endblock %}